

#include <stdio.h>
#include <unistd.h>    // for usleep()
#include <stdlib.h>

#define MAX 100

// Sender structure
typedef struct {
    int windowSize;
    int window[MAX];
    int front, rear;
    int nextSeqNum;
    int ackNum;
} Sender;

// Initialize sender
void initSender(Sender *s, int windowSize) {
    s->windowSize = windowSize;
    s->front = 0;
    s->rear = -1;
    s->nextSeqNum = 0;
    s->ackNum = -1;   // last ACKed sequence number (none yet)
}

// Enqueue packet
void enqueue(Sender *s, int seq) {
    if (s->rear < MAX - 1) {
        s->rear++;
        s->window[s->rear] = seq;
    }
}

// Dequeue packet
void dequeue(Sender *s) {
    if (s->front <= s->rear) {
        s->front++;
    }
}

// Peek front of queue
int peek(Sender *s) {
    if (s->front <= s->rear)
        return s->window[s->front];
    return -1;
}

// Send packets within window
void sendPacket(Sender *s) {
    while (s->nextSeqNum < s->ackNum + 1 + s->windowSize) {
        printf("Sending packet: %d\n", s->nextSeqNum);
        enqueue(s, s->nextSeqNum);
        s->nextSeqNum++;
        usleep(300000); // simulate delay (0.3 sec)
    }
}

// Receive ACK
void receiveAck(Sender *s, int ack) {
    if (ack > s->ackNum && ack < s->nextSeqNum) {
        printf("Received ACK for packet: %d\n", ack);
        s->ackNum = ack;
        // Remove acknowledged packets
        while (s->front <= s->rear && peek(s) <= s->ackNum) {
            dequeue(s);
        }
        // Send next packets if window allows
        sendPacket(s);
    } else if (ack == s->ackNum) {
        printf("Duplicate ACK for packet: %d\n", ack);
    } else {
        printf("Invalid ACK: %d (expected > %d and < %d)\n", ack, s->ackNum, s->nextSeqNum);
    }
}

// Receiver simulation (manual ACK input)
void simulateReceiver(Sender *s) {
    int ack;
    while (1) {
        printf("\nEnter ACK number (or -1 to exit): ");
        if (scanf("%d", &ack) != 1) {
            // clear input and continue
            int c; while ((c = getchar()) != '\n' && c != EOF) ;
            printf("Invalid input. Try again.\n");
            continue;
        }
        if (ack == -1) {
            printf("Exiting...\n");
            break;
        }
        receiveAck(s, ack);
    }
}

int main() {
    int windowSize;
    printf("Enter window size: ");
    if (scanf("%d", &windowSize) != 1 || windowSize <= 0) {
        printf("Invalid window size. Exiting.\n");
        return 1;
    }

    Sender sender;
    initSender(&sender, windowSize);

    // Start sending packets up to initial window
    sendPacket(&sender);

    // Receiver (interactive) will provide ACK numbers
    simulateReceiver(&sender);

    return 0;
}
